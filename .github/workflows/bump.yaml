name: bump
on: 'pull_request'

permissions:
  contents: write

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.user.login == 'dependabot[bot]' }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
          git checkout -b "$GITHUB_HEAD_REF"

      - name: Dependabot metadata
        id: dependabot-metadata
        uses: dependabot/fetch-metadata@21025c705c08248db411dc16f3619e6b5f9ea21a # v2.5.0

      - name: Install node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 18
      
      - name: Install semver
        run: |-
          npm install -g semver

      - name: Bump
        run: |-
          set -e
          push=0
          config='[
            {
              "directory": "helm/charts/nack",
              "dependencyName": "natsio/jetstream-controller"
            },
            {
              "directory": "helm/charts/nats-kafka",
              "dependencyName": "natsio/nats-kafka"
            },
            {
              "directory": "helm/charts/nats-operator",
              "dependencyName": "connecteverything/nats-operator"
            },
            {
              "directory": "helm/charts/nats",
              "dependencyName": "nats"
            },
            {
              "directory": "helm/charts/surveyor",
              "dependencyName": "natsio/nats-surveyor"
            }
          ]'

          deps='${STEPS_DEPENDABOT_METADATA_OUTPUTS_UPDATED_DEPENDENCIES_JSON}'

          for i in $(seq 0 "$(("$(echo "$config" | jq length) - 1"))"); do
            directory="$(echo "$config" | jq -r ".[$i].directory")"
            dependencyName="$(echo "$config" | jq -r ".[$i].dependencyName")"
            match="$(echo "$deps" | jq ".[] | select(.directory == \"/$directory\" and .dependencyName == \"$dependencyName\")")"
            if [ -z "$match" ]; then
              continue
            fi

            updateType="$(echo "$match" | jq -r ".updateType")"
            prevVersion="$(echo "$match" | jq -r ".prevVersion")"
            newVersion="$(echo "$match" | jq -r ".newVersion")"

            echo "directory        : $directory"
            echo "dependencyName   : $dependencyName"
            echo "updateType       : $updateType"
            echo "prevVersion      : $prevVersion"
            echo "newVersion       : $newVersion"

            newVersionSemVer=$(semver -c $newVersion)
            echo "newVersionSemVer : $newVersion"

            prevChartVersion=$(sed -rn 's/^version:\s+([0-9]+\.[0-9]+\.[0-9]+)/\1/p' "$directory/Chart.yaml")
            echo "prevChartVersion : $prevChartVersion"

            semverIncr="patch"
            if [ $updateType = "version-update:semver-major" ]; then
              semverIncr="major"
              if echo "$prevChartVersion" | grep -q "^0\."; then
                semverIncr="minor"
              fi
            elif [ $updateType = "version-update:semver-minor" ]; then
              semverIncr="minor"
            fi

            newChartVersion=$(semver -i "$semverIncr" "$prevChartVersion")
            echo "newChartVersion  : $newChartVersion"

            sed -i "s|^appVersion:\s.*|appVersion: $newVersionSemVer|;s|^version:\s.*|version: $newChartVersion|" "$directory/Chart.yaml"

            # Download CRDs for NACK controller updates
            if [ "$dependencyName" = "natsio/jetstream-controller" ]; then
              echo "Downloading CRDs for NACK v$newVersionSemVer..."
              crd_url="https://github.com/nats-io/nack/releases/download/v${newVersionSemVer}/crds.yml"
              crd_path="$directory/crds/crds.yml"

              # Ensure directory exists
              mkdir -p "$(dirname "$crd_path")"

              if curl -fsSL "$crd_url" -o "$crd_path"; then
                echo "✓ CRDs downloaded successfully from $crd_url"
                git add "$crd_path"
              else
                echo "✗ Error: Failed to download CRDs from $crd_url"
                echo "Cannot proceed with version bump without CRD update"
                exit 1
              fi
            fi

            # Prepare commit message
            commit_msg="[$(basename "$directory") helm] bump chart to version: $newChartVersion appVersion: $newVersionSemVer"
            if [ "$dependencyName" = "natsio/jetstream-controller" ]; then
              commit_msg="$commit_msg (with CRDs)"
            fi

            git add "$directory/Chart.yaml"
            if git commit -m "$commit_msg"; then
              push=1
            fi
          done

          if [ "$push" = "1" ]; then
            git push -u origin "$GITHUB_HEAD_REF"
          fi

        env:
          STEPS_DEPENDABOT_METADATA_OUTPUTS_UPDATED_DEPENDENCIES_JSON: ${{ steps.dependabot-metadata.outputs.updated-dependencies-json }}
