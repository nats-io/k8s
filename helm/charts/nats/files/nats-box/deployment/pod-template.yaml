metadata:
  labels:
    {{- include "natsBox.labels" $ | nindent 4 }}
spec:
  containers:
  {{- with .Values.natsBox.container }}
  - {{ include "nats.loadMergePatch" (merge (dict "file" "nats-box/deployment/container.yaml" "ctx" $) .) | nindent 4 }}
  {{- end }}

  volumes:
  # contexts secret
  - name: contexts
    secret:
      secretName: {{ .Values.natsBox.contextsSecret.name }}
  # contents secret
  - name: contents
    secret:
      secretName: {{ .Values.natsBox.contentsSecret.name }}
  # context secrets
  {{- range $ctxKey, $ctxVal := .Values.natsBox.contexts }}
  {{- range $secretKey, $secretVal := dict "creds" "nats-creds" "nkey" "nats-nkeys" "tls" "nats-certs" }}
  {{- $secret := get $ctxVal $secretKey }}
  {{- if and $secret $secret.secretName }}
  - name: ctx-{{ $ctxKey }}-{{ $secretKey }}
    secret:
      secretName: {{ $secret.secretName | quote }}
  {{- end }}
  {{- end }}
  {{- end }}
